name: Playwright PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  deployments: read
  pull-requests: read

concurrency:
  group: playwright-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  resolve-preview-url:
    runs-on: ubuntu-latest
    outputs:
      preview_url: ${{ steps.find-preview.outputs.preview_url }}
    steps:
      - name: Find preview URL for this PR commit
        id: find-preview
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.payload.pull_request.head.sha;
            const deployments = await github.paginate(
              github.rest.repos.listDeployments,
              { owner, repo, sha, per_page: 20 }
            );

            for (const deployment of deployments) {
              const statuses = await github.paginate(
                github.rest.repos.listDeploymentStatuses,
                {
                  owner,
                  repo,
                  deployment_id: deployment.id,
                  per_page: 20
                }
              );

              const successStatus = statuses.find((status) => status.state === 'success');
              const previewUrl = successStatus?.environment_url || successStatus?.target_url || '';

              if (previewUrl && previewUrl.includes('.vercel.app')) {
                core.info(`Vercel preview URL found: ${previewUrl}`);
                core.setOutput('preview_url', previewUrl);
                return;
              }
            }

            core.info('No Vercel preview URL available for this PR commit.');
            core.setOutput('preview_url', '');

  playwright:
    needs: resolve-preview-url
    if: needs.resolve-preview-url.outputs.preview_url != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browser
        run: npx playwright install --with-deps chromium

      - name: Run Playwright checks against preview URL
        run: npm run test:e2e
        env:
          ENVIRONMENT_URL: ${{ needs.resolve-preview-url.outputs.preview_url }}

  no-preview-url:
    needs: resolve-preview-url
    if: needs.resolve-preview-url.outputs.preview_url == ''
    runs-on: ubuntu-latest
    steps:
      - name: Skip Playwright checks
        run: echo "No preview URL available for this PR commit, skipping Playwright checks."
